---
description: ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”, Redis ìºì‹± ì „ëµ, N+1 ë¬¸ì œ í•´ê²°, ë¹„ë™ê¸° ì²˜ë¦¬, JVM íŠœë‹ê³¼ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ê°€ì´ë“œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
globs: 
alwaysApply: false
---
# âš¡ ì„±ëŠ¥ ìµœì í™” ë° ëª¨ë‹ˆí„°ë§ ê·œì¹™

## ğŸ¯ ì„±ëŠ¥ ìµœì í™” ì›ì¹™

### ê¸°ë³¸ ì„±ëŠ¥ ëª©í‘œ
- **API ì‘ë‹µ ì‹œê°„**: 95% ìš”ì²­ì´ 200ms ì´ë‚´
- **ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬**: í‰ê·  50ms ì´ë‚´
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: í™ ë©”ëª¨ë¦¬ 80% ë¯¸ë§Œ ìœ ì§€
- **CPU ì‚¬ìš©ë¥ **: í‰ìƒì‹œ 70% ë¯¸ë§Œ ìœ ì§€

### ìµœì í™” ìš°ì„ ìˆœìœ„
1. **ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”** (ê°€ì¥ í° ì„±ëŠ¥ ì˜í–¥)
2. **ìºì‹± ì „ëµ** (ë°˜ë³µ ì¡°íšŒ ìµœì í™”)
3. **ë¹„ë™ê¸° ì²˜ë¦¬** (ì‘ë‹µ ì‹œê°„ ë‹¨ì¶•)
4. **ë©”ëª¨ë¦¬ ê´€ë¦¬** (GC ìµœì í™”)

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”

### JPA ì„±ëŠ¥ ìµœì í™” ì„¤ì •
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        # ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™”
        jdbc:
          batch_size: 1000
          order_inserts: true
          order_updates: true
        
        # ì¿¼ë¦¬ ìµœì í™”
        default_batch_fetch_size: 100
        enable_lazy_load_no_trans: false
        
        # í†µê³„ ë° ëª¨ë‹ˆí„°ë§
        generate_statistics: true
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 100
```

### N+1 ë¬¸ì œ í•´ê²°
```java
@Entity
@NamedEntityGraph(
    name = "User.withRoles",
    attributeNodes = @NamedAttributeNode("roles")
)
public class User {
    @ManyToMany(fetch = FetchType.LAZY)
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
}

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // EntityGraph ì‚¬ìš©ìœ¼ë¡œ N+1 ë¬¸ì œ í•´ê²°
    @EntityGraph("User.withRoles")
    @Query("SELECT u FROM User u WHERE u.status = :status")
    List<User> findAllActiveUsers(@Param("status") UserStatus status);
    
    // Fetch Join ì‚¬ìš©
    @Query("SELECT DISTINCT u FROM User u LEFT JOIN FETCH u.roles WHERE u.email = :email")
    Optional<User> findByEmailWithRoles(@Param("email") String email);
    
    // DTO Projectionìœ¼ë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
    @Query("SELECT new com.sbpb.ddobak.server.domain.user.dto.UserSummaryDto" +
           "(u.id, u.email, u.name, u.status) FROM User u WHERE u.status = :status")
    List<UserSummaryDto> findUserSummaries(@Param("status") UserStatus status);
}
```

### ì»¤ìŠ¤í…€ Repository êµ¬í˜„ (ë³µì¡í•œ ì¿¼ë¦¬ ìµœì í™”)
```java
@Repository
@RequiredArgsConstructor
public class UserRepositoryCustomImpl implements UserRepositoryCustom {
    
    private final JPAQueryFactory queryFactory;
    
    @Override
    public Page<UserResponse> findUsersWithFilters(UserSearchCondition condition, Pageable pageable) {
        QUser user = QUser.user;
        QRole role = QRole.role;
        
        // ì¡°ê±´ì ˆ ë™ì  ìƒì„±
        BooleanBuilder builder = new BooleanBuilder();
        
        if (StringUtils.hasText(condition.getEmail())) {
            builder.and(user.email.containsIgnoreCase(condition.getEmail()));
        }
        
        if (condition.getStatus() != null) {
            builder.and(user.status.eq(condition.getStatus()));
        }
        
        if (condition.getCreatedAfter() != null) {
            builder.and(user.createdAt.goe(condition.getCreatedAfter()));
        }
        
        // ì¹´ìš´íŠ¸ ì¿¼ë¦¬ (ì„±ëŠ¥ ìµœì í™”)
        Long total = queryFactory
            .select(user.count())
            .from(user)
            .where(builder)
            .fetchOne();
        
        // ë°ì´í„° ì¡°íšŒ ì¿¼ë¦¬
        List<UserResponse> content = queryFactory
            .select(Projections.constructor(UserResponse.class,
                user.id,
                user.email,
                user.name,
                user.status,
                user.createdAt,
                user.updatedAt))
            .from(user)
            .where(builder)
            .orderBy(getOrderSpecifier(pageable.getSort()))
            .offset(pageable.getOffset())
            .limit(pageable.getPageSize())
            .fetch();
        
        return new PageImpl<>(content, pageable, total);
    }
    
    private OrderSpecifier<?>[] getOrderSpecifier(Sort sort) {
        QUser user = QUser.user;
        return sort.stream()
            .map(order -> {
                String property = order.getProperty();
                boolean isAsc = order.getDirection().isAscending();
                
                return switch (property) {
                    case "email" -> isAsc ? user.email.asc() : user.email.desc();
                    case "name" -> isAsc ? user.name.asc() : user.name.desc();
                    case "createdAt" -> isAsc ? user.createdAt.asc() : user.createdAt.desc();
                    default -> isAsc ? user.id.asc() : user.id.desc();
                };
            })
            .toArray(OrderSpecifier[]::new);
    }
}
```

### ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ìµœì í™”
```sql
-- ë³µí•© ì¸ë±ìŠ¤ ìƒì„± (ì¿¼ë¦¬ íŒ¨í„´ì— ë”°ë¼)
CREATE INDEX idx_user_status_created_at ON users(status, created_at);
CREATE INDEX idx_user_email_status ON users(email, status);

-- ë¶€ë¶„ ì¸ë±ìŠ¤ (ì¡°ê±´ë¶€ ì¸ë±ìŠ¤)
CREATE INDEX idx_active_users_email ON users(email) WHERE status = 'ACTIVE';

-- ì»¤ë²„ë§ ì¸ë±ìŠ¤ (í•„ìš”í•œ ëª¨ë“  ì»¬ëŸ¼ í¬í•¨)
CREATE INDEX idx_user_covering ON users(status, email, name, created_at);
```

## ğŸš€ ìºì‹± ì „ëµ

### Redis ìºì‹œ ì„¤ì •
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(config)
            .transactionAware()
            .build();
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

### ìºì‹œ ì ìš© ì˜ˆì‹œ
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class UserService {
    
    private final UserRepository userRepository;
    private final RedisTemplate<String, Object> redisTemplate;
    
    // ë‹¨ìˆœ ì¡°íšŒ ìºì‹±
    @Cacheable(value = "users", key = "#userId")
    public UserResponse getUserById(Long userId) {
        log.debug("Fetching user from database: {}", userId);
        
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException(userId));
        
        return UserResponse.from(user);
    }
    
    // ì¡°ê±´ë¶€ ìºì‹±
    @Cacheable(value = "users", key = "#email", condition = "#email.length() > 0")
    public Optional<UserResponse> getUserByEmail(String email) {
        return userRepository.findByEmail(email)
            .map(UserResponse::from);
    }
    
    // ìºì‹œ ì—…ë°ì´íŠ¸
    @CachePut(value = "users", key = "#result.id")
    public UserResponse updateUser(Long userId, UpdateUserRequest request) {
        User user = userRepository.findById(userId)
            .orElseThrow(() -> new UserNotFoundException(userId));
        
        user.updateInfo(request.getName());
        User updatedUser = userRepository.save(user);
        
        return UserResponse.from(updatedUser);
    }
    
    // ìºì‹œ ì‚­ì œ
    @CacheEvict(value = "users", key = "#userId")
    public void deleteUser(Long userId) {
        userRepository.deleteById(userId);
    }
    
    // ë³µì¡í•œ ìºì‹± ë¡œì§
    public List<UserResponse> getPopularUsers() {
        String cacheKey = "popular_users";
        
        // ìºì‹œì—ì„œ ì¡°íšŒ ì‹œë„
        List<UserResponse> cachedUsers = (List<UserResponse>) 
            redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedUsers != null) {
            log.debug("Retrieved popular users from cache");
            return cachedUsers;
        }
        
        // ìºì‹œ ë¯¸ìŠ¤ ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ
        List<User> users = userRepository.findPopularUsers();
        List<UserResponse> responses = users.stream()
            .map(UserResponse::from)
            .collect(Collectors.toList());
        
        // ìºì‹œì— ì €ì¥ (5ë¶„ TTL)
        redisTemplate.opsForValue().set(cacheKey, responses, Duration.ofMinutes(5));
        
        log.debug("Cached popular users for 5 minutes");
        return responses;
    }
}
```

### ìºì‹œ í‚¤ ì„¤ê³„ ì›ì¹™
```java
@Component
public class CacheKeyGenerator {
    
    private static final String DELIMITER = ":";
    
    public static String userKey(Long userId) {
        return "user" + DELIMITER + userId;
    }
    
    public static String userSessionKey(Long userId, String sessionId) {
        return "user_session" + DELIMITER + userId + DELIMITER + sessionId;
    }
    
    public static String searchResultKey(String query, int page, int size) {
        return "search" + DELIMITER + 
               DigestUtils.md5DigestAsHex(query.getBytes()) + DELIMITER + 
               page + DELIMITER + size;
    }
    
    // íƒœê·¸ ê¸°ë°˜ ìºì‹œ í‚¤ (ì¼ê´„ ì‚­ì œìš©)
    public static String userTaggedKey(Long userId) {
        return "tag:user:" + userId;
    }
}
```

## âš¡ ë¹„ë™ê¸° ì²˜ë¦¬

### Async ì„¤ì •
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean(name = "taskExecutor")
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-task-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
    
    @Bean(name = "emailExecutor")
    public TaskExecutor emailExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(50);
        executor.setThreadNamePrefix("email-task-");
        executor.initialize();
        return executor;
    }
}
```

### ë¹„ë™ê¸° ë©”ì„œë“œ êµ¬í˜„
```java
@Service
@RequiredArgsConstructor
@Slf4j
public class NotificationService {
    
    private final EmailService emailService;
    private final SmsService smsService;
    
    @Async("emailExecutor")
    public CompletableFuture<Void> sendWelcomeEmail(String email, String name) {
        try {
            log.info("Sending welcome email to: {}", email);
            emailService.sendWelcomeEmail(email, name);
            log.info("Welcome email sent successfully to: {}", email);
            return CompletableFuture.completedFuture(null);
        } catch (Exception e) {
            log.error("Failed to send welcome email to: {}", email, e);
            return CompletableFuture.failedFuture(e);
        }
    }
    
    @Async("taskExecutor")
    public CompletableFuture<String> processLargeFile(String filePath) {
        try {
            log.info("Starting file processing: {}", filePath);
            
            // ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬ ë¡œì§
            String result = performFileProcessing(filePath);
            
            log.info("File processing completed: {}", filePath);
            return CompletableFuture.completedFuture(result);
        } catch (Exception e) {
            log.error("File processing failed: {}", filePath, e);
            return CompletableFuture.failedFuture(e);
        }
    }
    
    // ì—¬ëŸ¬ ë¹„ë™ê¸° ì‘ì—… ì¡°í•©
    public CompletableFuture<UserNotificationResult> sendUserNotifications(Long userId) {
        CompletableFuture<Void> emailFuture = sendWelcomeEmail(user.getEmail(), user.getName());
        CompletableFuture<Void> smsFuture = sendWelcomeSms(user.getPhone(), user.getName());
        
        return CompletableFuture.allOf(emailFuture, smsFuture)
            .thenApply(v -> UserNotificationResult.success(userId))
            .exceptionally(ex -> {
                log.error("Failed to send notifications for user: {}", userId, ex);
                return UserNotificationResult.failure(userId, ex.getMessage());
            });
    }
}
```

## ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### Actuator ì„¤ì •
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,httptrace
  endpoint:
    health:
      show-details: when_authorized
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5, 0.95, 0.99
```

### ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ìŠ¤
```java
@Component
@RequiredArgsConstructor
public class UserMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter userCreationCounter;
    private final Timer userServiceTimer;
    private final Gauge activeUserGauge;
    
    public UserMetrics(MeterRegistry meterRegistry, UserRepository userRepository) {
        this.meterRegistry = meterRegistry;
        
        // ì¹´ìš´í„° ë©”íŠ¸ë¦­
        this.userCreationCounter = Counter.builder("user.creation.count")
            .description("Number of users created")
            .register(meterRegistry);
        
        // íƒ€ì´ë¨¸ ë©”íŠ¸ë¦­
        this.userServiceTimer = Timer.builder("user.service.duration")
            .description("User service method execution time")
            .register(meterRegistry);
        
        // ê²Œì´ì§€ ë©”íŠ¸ë¦­
        this.activeUserGauge = Gauge.builder("user.active.count")
            .description("Number of active users")
            .register(meterRegistry, userRepository, this::getActiveUserCount);
    }
    
    public void incrementUserCreation() {
        userCreationCounter.increment();
    }
    
    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }
    
    public void recordUserServiceTime(Timer.Sample sample) {
        sample.stop(userServiceTimer);
    }
    
    private double getActiveUserCount(UserRepository userRepository) {
        return userRepository.countByStatus(UserStatus.ACTIVE);
    }
}

@Service
@RequiredArgsConstructor
public class UserService {
    
    private final UserRepository userRepository;
    private final UserMetrics userMetrics;
    
    public UserResponse createUser(CreateUserRequest request) {
        Timer.Sample sample = userMetrics.startTimer();
        
        try {
            // ì‚¬ìš©ì ìƒì„± ë¡œì§
            User user = // ... ì‚¬ìš©ì ìƒì„±
            User savedUser = userRepository.save(user);
            
            userMetrics.incrementUserCreation();
            
            return UserResponse.from(savedUser);
        } finally {
            userMetrics.recordUserServiceTime(sample);
        }
    }
}
```

### APM í†µí•© (Application Performance Monitoring)
```java
@Configuration
public class TracingConfig {
    
    @Bean
    public Sampler alwaysSampler() {
        return Sampler.create(1.0f); // 100% ìƒ˜í”Œë§ (ê°œë°œí™˜ê²½)
        // return Sampler.create(0.1f); // 10% ìƒ˜í”Œë§ (ìš´ì˜í™˜ê²½)
    }
    
    @Bean
    public OpenTracing jaegerTracer() {
        return Configuration.fromEnv().getTracer();
    }
}

// ë©”ì„œë“œ ë ˆë²¨ íŠ¸ë ˆì´ì‹±
@NewSpan("user-service")
public UserResponse createUser(@SpanTag("email") String email, CreateUserRequest request) {
    // ìŠ¤íŒ¬ì— ì¶”ê°€ ì •ë³´ ê¸°ë¡
    Span span = tracer.activeSpan();
    if (span != null) {
        span.setTag("user.request.size", request.toString().length());
        span.log("Starting user creation process");
    }
    
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    UserResponse response = processUserCreation(request);
    
    if (span != null) {
        span.setTag("user.id", response.getId());
        span.log("User creation completed successfully");
    }
    
    return response;
}
```

## ğŸ”§ JVM ë° GC ìµœì í™”

### JVM ì˜µì…˜ (application.yml)
```yaml
# JVM í™ ë©”ëª¨ë¦¬ ì„¤ì •
JAVA_OPTS: >
  -Xms2g 
  -Xmx4g
  -XX:NewRatio=1
  -XX:SurvivorRatio=8
  
  # G1GC ì‚¬ìš© (Java 17 ê¶Œì¥)
  -XX:+UseG1GC
  -XX:MaxGCPauseMillis=200
  -XX:G1HeapRegionSize=16m
  
  # GC ë¡œê¹…
  -Xlog:gc*:gc.log:time,tags
  
  # ë©”ëª¨ë¦¬ ë¤í”„ (OOM ì‹œ)
  -XX:+HeapDumpOnOutOfMemoryError
  -XX:HeapDumpPath=/logs/heapdump.hprof
  
  # ë„¤ì´í‹°ë¸Œ ë©”ëª¨ë¦¬ íŠ¸ë˜í‚¹
  -XX:NativeMemoryTracking=summary
```

### ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
```java
@Service
public class FileProcessingService {
    
    // âŒ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜
    private static final Map<String, ProcessingResult> CACHE = new HashMap<>();
    
    // âœ… ë©”ëª¨ë¦¬ ì•ˆì „í•œ ìºì‹œ
    private final Cache<String, ProcessingResult> cache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofHours(1))
        .removalListener((key, value, cause) -> {
            if (value instanceof Closeable) {
                try {
                    ((Closeable) value).close();
                } catch (IOException e) {
                    log.warn("Failed to close resource: {}", key, e);
                }
            }
        })
        .build();
    
    public ProcessingResult processFile(String fileName) {
        return cache.get(fileName, this::doProcessFile);
    }
    
    // ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë³´ì¥
    @PreDestroy
    public void cleanup() {
        cache.invalidateAll();
    }
}
```

## ğŸ“‹ ì„±ëŠ¥ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
- [ ] N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²° (EntityGraph, Fetch Join)
- [ ] ì ì ˆí•œ ì¸ë±ìŠ¤ ìƒì„± ë° í™œìš©
- [ ] ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš ë¶„ì„ ë° ìµœì í™”
- [ ] ë°°ì¹˜ ì²˜ë¦¬ í™œìš© (Batch Insert/Update)
- [ ] ì»¤ë„¥ì…˜ í’€ ì„¤ì • ìµœì í™”

### ìºì‹± ì „ëµ
- [ ] ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹±
- [ ] ì ì ˆí•œ ìºì‹œ TTL ì„¤ì •
- [ ] ìºì‹œ ë¬´íš¨í™” ì „ëµ êµ¬í˜„
- [ ] ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§

### ë¹„ë™ê¸° ì²˜ë¦¬
- [ ] I/O ì§‘ì•½ì  ì‘ì—… ë¹„ë™ê¸° ì²˜ë¦¬
- [ ] ì ì ˆí•œ ìŠ¤ë ˆë“œ í’€ ì„¤ì •
- [ ] ë°±í”„ë ˆì…” ì²˜ë¦¬ êµ¬í˜„
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ ë° ëª¨ë‹ˆí„°ë§

### ëª¨ë‹ˆí„°ë§ ë° ì¸¡ì •
- [ ] ì‘ë‹µ ì‹œê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- [ ] ì—ëŸ¬ìœ¨ ëª¨ë‹ˆí„°ë§
- [ ] ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì¶”ì 
- [ ] ì•Œë¦¼ ë° ì„ê³„ê°’ ì„¤ì •
